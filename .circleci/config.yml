version: 2

jobs:
  build_cpp:
    docker:
      - image: appliedblockchain/snarkapps-base
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASSWORD
    steps:
      - checkout
      - run:
          name: Init Git submodules
          command: git submodule update --init --recursive
      - run:
          name: "Create hash of src contents"
          command: find cpp/src -type f | sort | xargs cat | md5sum > srchash.txt
      - restore_cache:
          keys:
            - zktrading-{{ checksum "srchash.txt" }}
      - run:
          name: "C++: CMake"
          command: mkdir -p cpp/build && cd cpp/build && cmake ..
      - run:
          name: "C++: Make"
          command: cd cpp/build && make
      - save_cache:
         key: zktrading-{{ checksum "srchash.txt" }}
         paths:
           - cpp/build
      - persist_to_workspace:
          root: .
          paths:
            - cpp/build/src
            - cpp/build/test
  prepare_node:
    docker:
      - image: appliedblockchain/snarkapps-base
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASSWORD
    steps:
      - checkout
      - run:
          name: Install npm modules
          command: cd js && npm i
      - persist_to_workspace:
          root: .
          paths:
            - js/node_modules

  run_private_trade_test:
    docker:
      - image: appliedblockchain/snarkapps-base
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASSWORD
      - image: appliedblockchain/parity-solo
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASSWORD
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Make sure npm modules are installed
          command: cd js && npm i
      - run:
          name: Setup
          command: |
            mkdir /tmp/k0keys
            for x in commitment addition transfer withdrawal
            do
            cpp/build/src/setup ${x} 16 /tmp/k0keys/${x}_pk /tmp/k0keys/${x}_vk
            cpp/build/src/convert_vk /tmp/k0keys/${x}_vk /tmp/k0keys/${x}_vk_alt
            done
      - run:
          name: Start server
          command: |
            cpp/build/src/server 16 /tmp/k0keys/commitment_pk \
            /tmp/k0keys/commitment_vk /tmp/k0keys/addition_pk \
            /tmp/k0keys/addition_vk /tmp/k0keys/transfer_pk \
            /tmp/k0keys/transfer_vk /tmp/k0keys/withdrawal_pk \
            /tmp/k0keys/withdrawal_vk 4000
          background: true
      - run:
          name: Run MVPPT test
          command: cd js && node_modules/.bin/mocha test/mvppt.js
      - run:
          name: Run private trade test
          command: cd js && node_modules/.bin/mocha test/private-trade.js

workflows:
  version: 2
  main:
    jobs:
      - build_cpp:
          context: org-global
      - prepare_node:
          context: org-global
      - run_private_trade_test:
          context: org-global
          requires:
            - build_cpp
            - prepare_node

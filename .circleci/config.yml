version: 2

jobs:
  build_cpp_docker:
    machine:
      image: circleci/classic:201808-01
      docker_layer_caching: true
    steps:
      - checkout
#      # Run this to reset the Docker layer cache
#      - run: docker images --no-trunc --format '{{.ID}}' | xargs docker rmi || true
      - run:
          name: "Get Git submodules"
          command: git submodule update --init --recursive
      - run:
          name: "Docker login"
          command: docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD"
      - run:
          name: "Download and tag previously generated images"
          command: |
            docker pull appliedblockchain/zktrading-builder:$CIRCLE_BRANCH || true
            docker tag appliedblockchain/zktrading-builder:$CIRCLE_BRANCH zktrading-builder || true
            docker pull appliedblockchain/zktrading:$CIRCLE_BRANCH || true
            docker tag appliedblockchain/zktrading:$CIRCLE_BRANCH zktrading || true
            for IMAGE in setup server mtserver convert-vk pack unpack
            do
              docker pull appliedblockchain/zktrading-$IMAGE:$CIRCLE_BRANCH || true
            done
      - run:
          name: "Build builder image"
          command: |
            cd cpp
            docker build -f docker/builder.Dockerfile -t zktrading-builder .
      - run:
          name: "Build main image"
          command: |
            cd cpp
            docker build -f docker/zktrading.Dockerfile -t zktrading .
      - run:
          name: "Build app images"
          command: |
            cd cpp
            for IMAGE in setup server mtserver convert-vk pack unpack
            do
              docker build -f docker/$IMAGE.Dockerfile -t appliedblockchain/zktrading-$IMAGE:$CIRCLE_BRANCH .
            done
      - run:
          name: "Push images"
          command: |
            cd cpp
            for IMAGE in zktrading-builder zktrading
            do
              docker tag $IMAGE appliedblockchain/$IMAGE:$CIRCLE_BRANCH
              docker push appliedblockchain/$IMAGE:$CIRCLE_BRANCH
            done
            for IMAGE in setup server mtserver convert-vk pack unpack
            do
              docker push appliedblockchain/zktrading-$IMAGE:$CIRCLE_BRANCH
              docker tag appliedblockchain/zktrading-$IMAGE:$CIRCLE_BRANCH appliedblockchain/zktrading-$IMAGE:$CIRCLE_BRANCH-$CIRCLE_SHA1
              docker push appliedblockchain/zktrading-$IMAGE:$CIRCLE_BRANCH-$CIRCLE_SHA1
            done

  prepare_node:
    machine:
      image: circleci/classic:201808-01
    steps:
      - checkout
      - run:
          name: "Enable NVM"
          command: |
            echo 'export NVM_DIR="/opt/circleci/.nvm"' >> $BASH_ENV
            echo ' [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> $BASH_ENV
      - run: 
          name: "Update node"
          command: |
            nvm install v8
            node -v
            nvm alias default v8
      - restore_cache:
          keys:
            - zktrading-js-deps-$CIRCLE_BRANCH-{{ checksum "js/package.json" }}
      - run:
          name: Install npm modules
          command: cd js && npm i
      - save_cache:
         key: zktrading-js-deps-$CIRCLE_BRANCH-{{ checksum "js/package.json" }}
         paths:
           - js/node_modules
      - persist_to_workspace:
          root: .
          paths:
            - js/node_modules

  # This could probably be run more efficiently on the docker executor
  chaincode:
    machine:
      image: circleci/classic:201808-01
      docker_layer_caching: true
    working_directory: ~/.go_workspace/src/github.com/appliedblockchain/zktrading
    steps:
      - checkout
      - run:
          name: "Docker login"
          command: docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD"
      - run:
          name: "Start server"
          command: |
            docker run -d \
            -p 11400:11400 \
            -v $PWD/fabric/chaincode/cash/testdata/:/tmp/k0keys/:ro \
            appliedblockchain/zktrading-server:$CIRCLE_BRANCH-$CIRCLE_SHA1 \
            6 \
            /tmp/k0keys/example_pk /tmp/k0keys/transfer_vk \
            /tmp/k0keys/example_pk /tmp/k0keys/transfer_vk \
            /tmp/k0keys/example_pk /tmp/k0keys/transfer_vk \
            /tmp/k0keys/example_pk /tmp/k0keys/transfer_vk \
            /tmp/k0keys/example_pk /tmp/k0keys/transfer_vk 11400
      - run:
          name: "Get Fabric source code"
          command: |
            cd ~/.go_workspace/src/github.com
            mkdir hyperledger
            cd hyperledger
            curl -LO https://github.com/hyperledger/fabric/archive/v1.2.0.tar.gz
            tar xf v1.2.0.tar.gz
            mv fabric-1.2.0 fabric
            rm v1.2.0.tar.gz
      - run:
          name: "Run Go tests"
          command: |
            cd fabric/chaincode/cash
            go test

  fabric:
    machine:
      image: circleci/classic:201808-01
      docker_layer_caching: true
    working_directory: ~/.go_workspace/src/github.com/appliedblockchain/zktrading
    steps:
      - checkout
      - run:
          name: "Enable NVM"
          command: |
            echo 'export NVM_DIR="/opt/circleci/.nvm"' >> $BASH_ENV
            echo ' [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> $BASH_ENV
      - run:
          name: "Update node"
          command: |
            nvm install v8
            node -v
            nvm alias default v8
      - run:
          name: "Docker login"
          command: docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD"
      - run:
          name: "Pull and tag app images"
          command: |
            cd cpp
            for IMAGE in setup server mtserver convert-vk pack unpack
            do
              docker pull appliedblockchain/zktrading-$IMAGE:$CIRCLE_BRANCH-$CIRCLE_SHA1
              docker tag appliedblockchain/zktrading-$IMAGE:$CIRCLE_BRANCH-$CIRCLE_SHA1 zktrading-$IMAGE
            done
      - attach_workspace:
          at: .
      - run:
          name: "Generate proving and verification keys"
          command: |
            mkdir /tmp/k0keys
            for circuit in commitment transfer addition withdrawal example
            do
              docker run -v /tmp/k0keys:/tmp/k0keys zktrading-setup $circuit 7 /tmp/k0keys/${circuit}_pk /tmp/k0keys/${circuit}_vk
              docker run -v /tmp/k0keys:/tmp/k0keys zktrading-convert-vk /tmp/k0keys/${circuit}_vk /tmp/k0keys/${circuit}_vk_alt
            done
      - run:
          name: "Remove old chaincode images"
          command: |
            docker rmi $(docker images --filter=reference="*k0chaincode*" -q) || true
      - run:
          name: "Get Fabric source code"
          command: |
            cd ~/.go_workspace/src/github.com
            mkdir hyperledger
            cd hyperledger
            curl -LO https://github.com/hyperledger/fabric/archive/v1.2.0.tar.gz
            tar xf v1.2.0.tar.gz
            mv fabric-1.2.0 fabric
            rm v1.2.0.tar.gz
      - run:
          name: "Package K0 chaincode"
          command: |
            cd js/test/fabric/network
            docker run \
            -v $PWD/artefacts:/artefacts \
            -v ~/.go_workspace/src/github.com/hyperledger/fabric:/opt/gopath/src/github.com/hyperledger/fabric:ro \
            -v ~/.go_workspace/src/github.com/appliedblockchain/zktrading/fabric/chaincode:/opt/gopath/src/github.com/appliedblockchain/zktrading/fabric/chaincode:ro \
            hyperledger/fabric-tools:1.2.0 \
            peer chaincode package -n k0chaincode -v 1 -p github.com/appliedblockchain/zktrading/fabric/chaincode/cash \
            /artefacts/k0chaincode.1.out
      - run:
          name: "Spin up Fabric network"
          command: |
            cd js/test/fabric/network
            CI=true ./start.sh
      - run:
          name: "Install K0 chaincode"
          command: |
            cd js/test/fabric/network
            for org in alpha beta gamma; do docker-compose run ${org}tools peer chaincode install /artefacts/k0chaincode.1.out; done
      - run:
          name: "Instantiate K0 chaincode"
          command: |
            cd js/test/fabric
            node instantiate
      - run:
          name: "Run integration tests"
          command: |
            cd js
            node_modules/.bin/mocha test/fabric/test.js

workflows:
  version: 2
  main:
    jobs:
      - build_cpp_docker:
          context: org-global
      - prepare_node:
          context: org-global
      - chaincode:
          context: org-global
          requires:
            - build_cpp_docker
      - fabric:
          context: org-global
          requires:
            - build_cpp_docker
            - prepare_node
